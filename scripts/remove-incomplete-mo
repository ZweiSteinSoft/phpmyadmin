#!/bin/sh
#
# Removes mo files for incomplete translations
#

set -e

#
# How many percent needs to be translated
#
THRESHOLD=50

if [ ! -z "$1" ] ; then
    THRESHOLD=$1
fi

echo '<?php' > libraries/language_stats.inc.php
echo '/* Automatically generated file, do not edit! */' >> libraries/language_stats.inc.php
echo '/* Generated by scripts/remove-incomplete-mo */' >> libraries/language_stats.inc.php
echo '' >> libraries/language_stats.inc.php
echo '$GLOBALS["language_stats"] = array (' >> libraries/language_stats.inc.php

check() {
    lang=`echo $1 | sed 's@po/\(.*\)\.po@\1@'`
    STATS=`LANG=C  msgfmt --statistics -o /dev/null $1 2>&1`
    if echo $STATS | grep -q ' translated ' ; then
        TRANSLATED=`echo $STATS | sed 's/\(^\|.* \)\([0-9]*\) translated.*/\2/'`
    else
        TRANSLATED=0
    fi
    if echo $STATS | grep -q ' fuzzy ' ; then
        FUZZY=`echo $STATS | sed 's/\(^\|.* \)\([0-9]*\) fuzzy.*/\2/'`
    else
        FUZZY=0
    fi
    if echo $STATS | grep -q ' untranslated ' ; then
        UNTRANSLATED=`echo $STATS | sed 's/\(^\|.* \)\([0-9]*\) untranslated.*/\2/'`
    else
        UNTRANSLATED=0
    fi
    PERCENT=`expr 100 \* $TRANSLATED / \( $TRANSLATED + $FUZZY + $UNTRANSLATED \) || true`
    echo "    '$lang' => $PERCENT," >> libraries/language_stats.inc.php

    if [ $PERCENT -lt $THRESHOLD ] ; then
        echo "Removing $lang, only $PERCENT%"
        rm -f locale/$lang/LC_MESSAGES/phpmyadmin.mo 
    fi
}

for x in po/*.po  ; do 
    check $x
done

echo ');' >> libraries/language_stats.inc.php
echo '?>' >> libraries/language_stats.inc.php
